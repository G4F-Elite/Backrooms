name: Build And Release

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows-client:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MinGW (w64devkit)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $url = "https://github.com/skeeto/w64devkit/releases/download/v2.1.0/w64devkit-x64-2.1.0.exe"
          Invoke-WebRequest -Uri $url -OutFile "$env:RUNNER_TEMP\w64devkit.exe"
          & "$env:RUNNER_TEMP\w64devkit.exe" x -o"$env:RUNNER_TEMP\w64devkit"
          "$env:RUNNER_TEMP\w64devkit\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build backrooms.exe
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if (!(Test-Path build)) { New-Item -ItemType Directory -Path build | Out-Null }
          g++ -std=c++17 -O2 -Wall -Wno-unused-result -Wno-unknown-pragmas -mwindows -static -static-libgcc -static-libstdc++ `
            -I"deps/include" `
            -o "build/backrooms.exe" `
            "src/game.cpp" `
            "deps/src/glad.c" `
            -L"deps/lib" `
            -lglfw3 -lopengl32 -lgdi32 -luser32 -lkernel32 -lwinmm -lws2_32

      - name: Package windows release files
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if (!(Test-Path release)) { New-Item -ItemType Directory -Path release | Out-Null }
          Copy-Item "build/backrooms.exe" "release/backrooms.exe" -Force
          Copy-Item "README.md" "release/README.md" -Force
          if (Test-Path "release/glfw3.dll") {
            throw "Single-EXE policy violated: unexpected glfw3.dll in release folder."
          }
          Compress-Archive -Path "release/*" -DestinationPath "build/backrooms-windows.zip" -Force

      - name: Upload windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: backrooms-windows
          path: |
            build/backrooms.exe
            build/backrooms-windows.zip

  build-linux-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Linux dedicated server
        run: |
          chmod +x build_server_linux.sh
          ./build_server_linux.sh

      - name: Package Linux server artifact
        run: |
          mkdir -p build/release
          cp build/linux/backrooms_server build/release/backrooms_server
          chmod +x build/release/backrooms_server
          tar -C build/release -czf build/backrooms-server-linux.tar.gz backrooms_server

      - name: Upload linux server artifact
        uses: actions/upload-artifact@v4
        with:
          name: backrooms-linux-server
          path: |
            build/linux/backrooms_server
            build/backrooms-server-linux.tar.gz

  create-release:
    runs-on: ubuntu-latest
    needs:
      - build-windows-client
      - build-linux-server
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download windows artifact
        uses: actions/download-artifact@v4
        with:
          name: backrooms-windows
          path: build/windows

      - name: Download linux server artifact
        uses: actions/download-artifact@v4
        with:
          name: backrooms-linux-server
          path: build/linux-server

      - name: Calculate version
        id: ver
        run: |
          date="$(date +'%Y.%m.%d')"
          sha="${GITHUB_SHA:0:7}"
          version="v${date}.${GITHUB_RUN_NUMBER}.${GITHUB_RUN_ATTEMPT}-${sha}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.ver.outputs.version }}" -m "Auto release ${{ steps.ver.outputs.version }}"
          git push origin "${{ steps.ver.outputs.version }}"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.version }}
          name: Backrooms ${{ steps.ver.outputs.version }}
          body: |
            Auto-generated release from commit ${{ github.sha }}.
            Builds:
            - Windows client (single EXE)
            - Linux dedicated server
          files: |
            build/windows/backrooms.exe
            build/windows/backrooms-windows.zip
            build/linux-server/backrooms_server
            build/linux-server/backrooms-server-linux.tar.gz
