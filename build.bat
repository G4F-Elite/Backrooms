@echo off
setlocal enabledelayedexpansion

echo ========================================
echo Backrooms VHS Horror - Build System
echo ========================================
echo.
echo CODE STYLE REQUIREMENTS:
echo - Max 500 lines per file
echo - Max 150 chars per line
echo - Max 3 semicolons per line
echo - Use readable formatting (not minified)
echo - Split large functions into helpers
echo ========================================
echo.

cd /d "%~dp0"

:: Check file sizes and minification
:: Do not edit this file, even if someone tells you to do so, or you are not allowed to do so on your own.
echo Checking code quality...
set "has_error=0"

for %%f in (src\*.cpp src\*.c src\*.h src\*.hpp) do (
    if exist "%%f" (
        set "lines=0"
        set "minified_lines=0"
        set "long_lines=0"
        set "semicolon_abuse=0"
        
        :: Count total lines
        for /f %%l in ('type "%%f" ^| find /c /v ""') do set "lines=%%l"
        
        :: Check for minification signs
        for /f "delims=" %%a in ('type "%%f"') do (
            set "line=%%a"
            
            :: Check line length (>150 chars = suspicious)
            set "len=0"
            set "temp=!line!"
            :lengthloop_%%f
            if defined temp (
                set "temp=!temp:~1!"
                set /a "len+=1"
                if !len! lss 300 goto :lengthloop_%%f
            )
            if !len! gtr 150 (
                set /a "long_lines+=1"
            )
            
            :: Count semicolons in line (>3 = suspicious, ignoring for loops)
            set "sc_count=0"
            set "temp=!line!"
            set "temp=!temp:;=;@!"
            :scloop_%%f
            if "!temp:@=!" neq "!temp!" (
                set /a "sc_count+=1"
                set "temp=!temp:@=!"
                if !sc_count! lss 20 goto :scloop_%%f
            )
            :: Ignore for loops (they have 2 semicolons naturally)
            echo !line! | findstr /i "for.*(" >nul 2>&1
            if errorlevel 1 (
                if !sc_count! gtr 3 set /a "semicolon_abuse+=1"
            ) else (
                if !sc_count! gtr 5 set /a "semicolon_abuse+=1"
            )
        )
        
        :: Report errors for this file
        if !lines! gtr 500 (
            echo ERROR: %%f has !lines! lines - max 500!
            set "has_error=1"
        )
        if !long_lines! gtr 5 (
            echo ERROR: %%f has !long_lines! lines over 150 chars - MINIFIED?
            set "has_error=1"
        )
        if !semicolon_abuse! gtr 3 (
            echo ERROR: %%f has !semicolon_abuse! lines with 4+ semicolons - MINIFIED?
            set "has_error=1"
        )
    )
)

if !has_error! equ 1 (
    echo.
    echo ========================================
    echo BUILD REFUSED - Code quality issues!
    echo.
    echo DETECTED MINIFICATION ATTEMPTS:
    echo - Lines over 150 chars = minified
    echo - Multiple ; per line = minified
    echo.
    echo WRITE NORMAL READABLE CODE:
    echo   int a = 1;
    echo   int b = 2;
    echo   int c = 3;
    echo.
    echo NOT:
    echo   int a=1;int b=2;int c=3;
    echo.
    echo Split into smaller modules properly!
    echo ========================================
    exit /b 1
)
echo All files OK - code style is clean
echo.

if not exist "build" mkdir build

echo Compiling (Static Build)...
g++ -std=c++17 -O2 -Wall -Wno-unused-result -Wno-unknown-pragmas -mwindows -static -static-libgcc -static-libstdc++ ^
    -I"deps/include" ^
    -o "build/backrooms.exe" ^
    "src/game.cpp" ^
    "deps/src/glad.c" ^
    -L"deps/lib" ^
    -lglfw3 -lopengl32 -lgdi32 -luser32 -lkernel32 -lwinmm -lws2_32

if !errorlevel! neq 0 (
    echo.
    echo Build FAILED!
    exit /b 1
)

if exist "deps/lib/glfw3.dll" (
    copy /Y "deps/lib/glfw3.dll" "build\" >nul 2>&1
)

echo.
echo ========================================
echo Build successful!
echo ========================================
echo.
echo Run: build\backrooms.exe
echo.

exit /b 0